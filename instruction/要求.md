# 支援模型场景生成规范

## 一、Scenario对象基本结构

每个场景（Scenario）对象必须包含以下字段：

### 1.1 基本属性
- **id**: 场景唯一标识符，使用下划线命名法（如 `equipment_deployment_strategy`）
- **model_name**: 模型名称，中文（如 "设备投放"、"越野物流"、"伤员救助"等）
- **name**: 场景名称，中文（如 "设备投放策略"、"越野物流策略"等）
- **example_input**: 示例输入文本，完整的任务描述，包含：
  - 起点坐标和目标坐标
  - 资源类型和数量
  - 时间约束
  - 环境约束或风险因素
- **reasoning_chain**: 推理链条，使用箭头（→）连接各推理步骤，展示完整的推理流程
- **prompt**: 专项要求说明，详细描述行为树必须包含的核心节点及其子节点结构
- **example_output**: 示例输出，包含 `default_focus`、`behavior_tree` 和 `node_insights` 三个部分

---

## 二、行为树（behavior_tree）结构规范

### 2.1 节点基本结构
每个节点必须包含以下字段：
```python
{
    "id": "node_id",           # 节点唯一标识符
    "label": "🎯 节点标签",    # 带emoji的节点标签，清晰直观
    "status": "completed",     # 节点状态：completed/active/pending
    "summary": "节点摘要描述", # 简要说明节点功能与输出
    "children": []             # 子节点列表
}
```

### 2.2 状态定义
- **completed**: 已完成，通常用于前序节点
- **active**: 当前激活/重点展示的节点（与 `default_focus` 对应）
- **pending**: 待执行的节点

### 2.3 层次结构要求
1. **根节点**：通常为 `task_analysis`（任务解析），解析任务描述中的关键要素
2. **策略节点**：综合性策略节点（如 `resource_support_strategy`），作为一级子节点
3. **核心功能节点**：策略节点的子节点，对应主要功能模块（如 `resource_assessment`、`demand_allocation_advice` 等）
4. **细节执行节点**：核心功能节点的子节点，详细展开具体执行步骤
5. **最大深度**：建议不超过5层，保持结构清晰

---

## 三、节点洞察（node_insights）结构规范

### 3.1 基本结构
每个重要节点都应在 `node_insights` 中提供详细说明：

```python
"node_id": {
    "title": "节点标题",           # 简洁的中文标题
    "summary": "节点功能概述",     # 1-2句话的功能说明
    "key_points": [               # 3-5个关键要点
        "要点1：具体说明",
        "要点2：技术细节",
        "要点3：输出结果"
    ],
    "knowledge_trace": "推理路径描述"  # 简洁的推理链条描述
}
```

### 3.2 核心节点的knowledge_graph规范

**重要**：对于核心决策节点（如标注了 "核心节点" 的节点），必须包含 `knowledge_graph` 字段。此字段届时将用于展示在页面右侧的推理图谱内。

#### 3.2.1 基本结构
```python
"knowledge_graph": {
    "nodes": [
        {
            "id": "node_id",
            "label": "节点标签",
            "type": "input/process/decision/output"
        }
    ],
    "edges": [
        {
            "source": "source_node_id",
            "target": "target_node_id"
        }
    ]
}
```

#### 3.2.2 节点类型（type）定义
- **input**: 输入节点，表示数据源或初始状态
- **process**: 处理节点，表示数据处理或计算过程
- **decision**: 决策节点，表示策略选择或判断分支
- **output**: 输出节点，表示最终结果或决策输出

#### 3.2.3 节点数量要求
**核心要求：knowledge_graph 中的节点数量必须 ≥ 8 个**

为实现这一要求，除了主推理链上的核心节点（通常4-6个），还需要增加一些**与任务相关但相关性较低的细节节点**。这些细节节点：
1. **不需要连接到主推理链**（即不出现在 edges 中，或只有单向连接）
2. **体现推理过程中的辅助信息或环境因素**
3. **增强图谱的完整性和真实性**

#### 3.2.4 细节节点设计示例

**示例1：资源评估场景**
主推理链：资源类别解析 → 追踪方式匹配 → 状态更新机制 → 异常识别

额外细节节点：
- "历史库存记录"（提供基线数据，但不直接参与推理）
- "环境温湿度"（影响资源保存，但非核心流程）
- "人工校验日志"（备用验证手段，非自动流程）
- "补给计划表"（相关背景信息）

**示例2：目标定位场景**
主推理链：环境解析 → 传感器融合定位 → 误差纠正 → 定位结果生成

额外细节节点：
- "历史航迹数据"（可用于参考，但非核心输入）
- "GPS信号强度"（影响精度，但融合算法会处理）
- "气象信息"（背景环境，间接影响）
- "通信延迟监控"（质量保障，非核心流程）
- "电池电量状态"（设备健康指标）

#### 3.2.5 图谱设计原则
1. **主推理链清晰**：核心的4-6个节点通过edges形成清晰的推理链条
2. **细节节点独立**：辅助细节节点可以不连接edges，或仅有单向连接到主链某个节点
3. **类型分布合理**：
   - input节点（2-3个）：数据源和辅助信息
   - process节点（3-4个）：核心处理步骤
   - decision节点（0-1个）：决策分支（如有）
   - output节点（1-2个）：最终输出
4. **标签简洁明确**：使用换行符 `\n` 分隔主标签和说明，提高可读性

#### 3.2.6 完整示例

```python
"knowledge_graph": {
    "nodes": [
        # 主推理链节点
        {"id": "category", "label": "资源类别解析", "type": "input"},
        {"id": "tracking", "label": "追踪方式匹配", "type": "process"},
        {"id": "status_update", "label": "状态更新机制", "type": "process"},
        {"id": "anomaly", "label": "异常识别", "type": "output"},
        
        # 辅助细节节点（与任务相关但相关性较低）
        {"id": "history_inventory", "label": "历史库存记录", "type": "input"},
        {"id": "env_temp", "label": "环境温湿度", "type": "input"},
        {"id": "manual_verify", "label": "人工校验日志", "type": "process"},
        {"id": "supply_plan", "label": "补给计划表", "type": "input"},
        {"id": "alert_threshold", "label": "告警阈值配置", "type": "input"}
    ],
    "edges": [
        # 主推理链连接
        {"source": "category", "target": "tracking"},
        {"source": "tracking", "target": "status_update"},
        {"source": "status_update", "target": "anomaly"},
        
        # 辅助节点的可选连接（单向，不形成闭环）
        {"source": "history_inventory", "target": "status_update"},
        {"source": "env_temp", "target": "status_update"}
        
        # 注意：manual_verify、supply_plan、alert_threshold 不连接到主链，独立存在
    ]
}
```

---

## 四、推理链条（reasoning_chain）设计规范

### 4.1 格式要求
- 使用箭头 `→` 连接各推理步骤
- 每个步骤使用括号 `（）` 包含详细说明
- 步骤之间逻辑清晰，依赖关系明确

### 4.2 示例
```
任务解析（资源类型、需求单位、时限要求）→ 
资源评估（资源类别解析、追踪方式匹配、状态更新机制、异常识别）→ 
需求分配建议（需求解析、库存计算、分配策略推理、分配方案生成）→ 
补给任务生成与调度（短缺资源识别、补给任务构建、运输与调度规划、任务执行检测）
```

---

## 五、knowledge_trace 规范

### 5.1 格式要求
- 简洁描述推理路径
- 使用 `→` 连接关键步骤
- 体现输入-处理-输出的逻辑关系

### 5.2 示例
```python
"knowledge_trace": "资源类别 + 价值等级 → 追踪技术能力评估 → 选择追踪方案。"
"knowledge_trace": "任务描述 → 需求字段抽取 → 结构化需求列表。"
"knowledge_trace": "历史消耗 + 当前库存 + 未来任务 → 短缺预测与告警。"
```

---

## 六、综合场景整合规范

### 6.1 场景整合原则
- 将多个独立功能模块整合为一个综合性大场景
- 保持各功能模块的独立性和完整性
- 通过策略节点统一协调各功能模块

### 6.2 示例结构
```
task_analysis（任务解析）
└── xxx_strategy（综合策略）
    ├── module_1（功能模块1）
    │   ├── sub_node_1_1
    │   ├── sub_node_1_2
    │   └── sub_node_1_3
    ├── module_2（功能模块2）
    │   ├── sub_node_2_1
    │   ├── sub_node_2_2
    │   └── sub_node_2_3
    └── module_3（功能模块3）
        ├── sub_node_3_1
        ├── sub_node_3_2
        └── sub_node_3_3
```

---

## 七、Prompt提示词规范

### 7.1 结构要求
Prompt必须清晰列出：
1. 行为树必须包含的核心节点
2. 每个核心节点的子节点要求
3. 哪些节点必须包含 `knowledge_graph` 字段
4. `knowledge_graph` 必须体现的推理链条
5. `node_insights` 中 `knowledge_trace` 的要求

### 7.2 示例格式
```
【模型名称-场景名称专项要求】
1. 行为树必须至少包含以下核心节点，严格按照推理链条自上而下展开：
   - node_1（节点1）：说明与要求；
   - node_2（节点2，核心节点）：必须包含以下子节点：
       * sub_node_2_1：说明；
       * sub_node_2_2：说明；
       必须包含 knowledge_graph 字段。
   - node_3（节点3）：说明与要求；
2. node_2 节点的 knowledge_graph 必须体现：步骤1 → 步骤2 → 步骤3。
3. 在 node_insights 中，所有节点的 knowledge_trace 必须体现完整推理路径。
```

---

## 八、质量检查清单

在完成场景编写后，请检查：

### 8.1 基本完整性
- [ ] 所有必需字段均已填写
- [ ] example_input 包含完整的任务描述
- [ ] reasoning_chain 逻辑清晰
- [ ] behavior_tree 层次结构合理

### 8.2 节点洞察
- [ ] 所有重要节点都有 node_insights
- [ ] 每个 node_insight 包含 title、summary、key_points、knowledge_trace
- [ ] 核心节点包含 knowledge_graph

### 8.3 知识图谱（knowledge_graph）
- [ ] 节点数量 ≥ 8 个
- [ ] 包含主推理链节点（4-6个）
- [ ] 包含辅助细节节点（2-4个）
- [ ] 主推理链通过 edges 连接清晰
- [ ] 细节节点独立或弱连接，不破坏主链逻辑
- [ ] 节点类型标注准确（input/process/decision/output）
- [ ] edges 形成有向无环图（DAG），避免循环依赖

### 8.4 可读性
- [ ] label 使用合适的 emoji
- [ ] summary 简洁明确
- [ ] key_points 具体实用
- [ ] 专业术语使用准确

---

## 九、常见错误与注意事项

### 9.1 常见错误
1. **节点数量不足**：knowledge_graph 中节点少于8个
2. **细节节点缺失**：只有主推理链节点，缺少辅助细节节点
3. **推理链断裂**：edges 连接不完整，逻辑跳跃
4. **类型标注错误**：input/process/output 使用不当
5. **节点ID重复**：同一图谱中节点ID不唯一
6. **循环依赖**：edges 形成闭环，导致推理逻辑混乱

### 9.2 注意事项
1. **细节节点的设计**：细节节点应真实反映推理过程中可能涉及的辅助信息，而非凑数
2. **边的方向性**：edges 必须体现因果关系和数据流向
3. **节点标签清晰**：使用换行符分隔主标签和说明，避免标签过长
4. **状态一致性**：behavior_tree 中节点的 status 应与 default_focus 保持一致
5. **中文规范**：使用规范的中文标点符号和术语

---

## 十、扩展建议

### 10.1 节点标签优化
- 使用动宾结构（如 "解析任务需求" 而非 "任务需求"）
- 突出节点功能（如 "生成分配方案" 而非 "分配方案"）
- 适当使用量词（如 "3辆无人车+1只机器狗"）

### 10.2 知识图谱可视化
设计 knowledge_graph 时，可在草稿中先绘制可视化图谱：
```
输入层：[资源类别] [历史数据] [环境信息]
         ↓          ↓
处理层：    [追踪方式匹配]
                ↓
处理层：    [状态更新机制] ← [人工校验]
                ↓
输出层：      [异常识别]
```
然后转换为 nodes 和 edges 的 JSON 结构。

### 10.3 模块化设计
对于复杂场景，可将 knowledge_graph 设计为分层结构：
- **主图谱**：核心推理链（4-6个节点）
- **辅助子图谱**：细节节点及其局部关系（2-4个节点）
- 通过少量边将子图谱连接到主图谱

---

## 附录：完整示例参考

请参考以下文件中的完整实现：
- `support_models/scenes/resource_support.py` - 资源保障策略综合场景
- `support_models/scenes/equipment_deployment.py` - 设备投放策略综合场景
- `support_models/scenes/casualty_rescue.py` - 伤员救助策略综合场景

这些文件展示了规范的完整应用，包括：
- 多层次行为树结构
- 详细的 node_insights
- 符合要求的 knowledge_graph（节点数 ≥ 8，包含细节节点）
- 清晰的推理链条

---

**文档版本**: v1.0  
**更新日期**: 2025-12-10  
**适用范围**: 所有支援模型场景开发

